{% extends 'base.html' %}

{% block title %}Complaint {{ complaint.tracking_id }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('admin.complaints') }}">Complaints</a></li>
      <li class="breadcrumb-item active">{{ complaint.tracking_id }}</li>
    </ol>
  </nav>

  <div class="row g-4">

    <!-- LEFT: Complaint Details -->
    <div class="col-lg-8">

      <!-- Header card -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
          <div>
            <h5 class="mb-0 fw-bold">
              <i class="fas fa-file-alt text-primary me-2"></i>
              Complaint {{ complaint.tracking_id }}
            </h5>
            <small class="text-muted">Submitted {{ complaint.submitted_at | format_datetime }}</small>
          </div>
          <span class="badge fs-6
            {% if complaint.status == 'Pending' %}bg-warning text-dark
            {% elif complaint.status == 'Under Review' %}bg-info text-dark
            {% elif complaint.status == 'Action Taken' %}bg-primary
            {% else %}bg-success{% endif %}">
            {{ complaint.status }}
          </span>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-sm-6">
              <p class="mb-1 text-muted small">Department</p>
              <p class="fw-semibold">{{ complaint.department.name }}</p>
            </div>
            <div class="col-sm-6">
              <p class="mb-1 text-muted small">Service</p>
              <p class="fw-semibold">{{ complaint.service.name }}</p>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-sm-6">
              <p class="mb-1 text-muted small">Assigned To</p>
              <p class="fw-semibold">
                {% if complaint.assigned_officer %}
                  <i class="fas fa-user text-success me-1"></i>{{ complaint.assigned_officer.username }}
                {% else %}
                  <span class="text-muted">Unassigned</span>
                {% endif %}
              </p>
            </div>
            <div class="col-sm-6">
              <p class="mb-1 text-muted small">Last Updated</p>
              <p class="fw-semibold">{{ complaint.updated_at | format_datetime }}</p>
            </div>
          </div>
          {% if complaint.resolved_at %}
          <div class="row mb-3">
            <div class="col-sm-6">
              <p class="mb-1 text-muted small">Resolved At</p>
              <p class="fw-semibold text-success">{{ complaint.resolved_at | format_datetime }}</p>
            </div>
            <div class="col-sm-6">
              <p class="mb-1 text-muted small">Resolution Time</p>
              <p class="fw-semibold">{{ complaint.resolution_days() }} days</p>
            </div>
          </div>
          {% endif %}

          <hr>

          <p class="mb-1 text-muted small">Description</p>
          <div class="bg-light rounded p-3">
            <p class="mb-0" style="white-space: pre-wrap;">{{ complaint.description }}</p>
          </div>

          {% if complaint.evidence_path %}
          <div class="mt-3">
            <p class="mb-1 text-muted small">Evidence File</p>
            <a href="{{ url_for('admin.download_evidence', tracking_id=complaint.tracking_id) }}"
               class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-paperclip me-1"></i> Download Evidence
            </a>
          </div>
          {% endif %}

          {% if complaint.resolution_notes %}
          <div class="mt-3">
            <p class="mb-1 text-muted small">Resolution Notes</p>
            <div class="bg-light rounded p-3">
              <p class="mb-0">{{ complaint.resolution_notes }}</p>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Audit Timeline -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
          <h6 class="mb-0 fw-bold">
            <i class="fas fa-history text-secondary me-2"></i>Audit Trail
          </h6>
        </div>
        <div class="card-body p-0">
          {% if audit_logs %}
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Timestamp</th>
                  <th>User</th>
                  <th>Action</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                {% for log in audit_logs %}
                <tr>
                  <td class="text-muted small">{{ log.timestamp | format_datetime }}</td>
                  <td><span class="badge bg-secondary">{{ log.username }}</span></td>
                  <td>{{ log.action }}</td>
                  <td class="text-muted small">{{ log.details or '—' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center text-muted py-4">
            <i class="fas fa-history fa-2x mb-2 d-block"></i>
            No audit entries yet.
          </div>
          {% endif %}
        </div>
      </div>

    </div><!-- /col-lg-8 -->

    <!-- RIGHT: Actions Panel -->
    <div class="col-lg-4">

      <!-- Assign Officer -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3">
          <h6 class="mb-0 fw-bold">
            <i class="fas fa-user-check text-primary me-2"></i>Assign Officer
          </h6>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('admin.assign_complaint', tracking_id=complaint.tracking_id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
              <label class="form-label small text-muted">Select Officer</label>
              <select name="officer_id" class="form-select" required>
                <option value="">-- Select Officer --</option>
                {% for officer in officers %}
                <option value="{{ officer.id }}"
                  {% if complaint.assigned_to == officer.id %}selected{% endif %}>
                  {{ officer.username }}
                  {% if officer.department %}({{ officer.department.name }}){% endif %}
                </option>
                {% endfor %}
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-save me-1"></i> Assign
            </button>
          </form>
        </div>
      </div>

      <!-- Update Status -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3">
          <h6 class="mb-0 fw-bold">
            <i class="fas fa-exchange-alt text-warning me-2"></i>Update Status
          </h6>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('admin.update_complaint_status', tracking_id=complaint.tracking_id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
              <label class="form-label small text-muted">New Status</label>
              <select name="status" class="form-select" required>
                {% for s in ['Pending', 'Under Review', 'Action Taken', 'Closed'] %}
                <option value="{{ s }}" {% if complaint.status == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label small text-muted">Notes (optional)</label>
              <textarea name="notes" class="form-control" rows="3"
                placeholder="Add investigation notes...">{{ complaint.resolution_notes or '' }}</textarea>
            </div>
            <button type="submit" class="btn btn-warning w-100 text-dark">
              <i class="fas fa-sync-alt me-1"></i> Update Status
            </button>
          </form>
        </div>
      </div>

      <!-- Quick Info -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
          <h6 class="mb-0 fw-bold">
            <i class="fas fa-info-circle text-info me-2"></i>Quick Info
          </h6>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0 small">
            <li class="d-flex justify-content-between py-2 border-bottom">
              <span class="text-muted">Tracking ID</span>
              <strong class="font-monospace">{{ complaint.tracking_id }}</strong>
            </li>
            <li class="d-flex justify-content-between py-2 border-bottom">
              <span class="text-muted">Department</span>
              <strong>{{ complaint.department.name }}</strong>
            </li>
            <li class="d-flex justify-content-between py-2 border-bottom">
              <span class="text-muted">Evidence</span>
              <strong>{% if complaint.evidence_path %}Yes{% else %}No{% endif %}</strong>
            </li>
            <li class="d-flex justify-content-between py-2">
              <span class="text-muted">Days Open</span>
              <strong>
                {% if complaint.resolved_at %}
                  {{ complaint.resolution_days() }} days
                {% else %}
                  {{ ((now() - complaint.submitted_at).days if now is defined else '—') }}
                {% endif %}
              </strong>
            </li>
          </ul>
        </div>
      </div>

    </div><!-- /col-lg-4 -->
  </div><!-- /row -->
</div>
{% endblock %}
